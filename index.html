<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1">
<title>TrackPush ‚Äî SAR Route Share</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<link href="https://fonts.googleapis.com/css2?family=Barlow:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
<style>
  :root {
    --orange: #E8651A;
    --orange-light: #FF8642;
    --orange-glow: rgba(232, 101, 26, 0.25);
    --dark: #0F1117;
    --dark-surface: #181B25;
    --dark-card: #1E2130;
    --dark-border: #2A2D3E;
    --text-primary: #F0F0F5;
    --text-secondary: #8B8FA3;
    --text-dim: #555872;
    --teal: #1ABFA0;
    --teal-glow: rgba(26, 191, 160, 0.2);
    --red: #E84545;
    --red-glow: rgba(232, 69, 69, 0.2);
    --amber: #F5A623;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: 'Barlow', -apple-system, sans-serif;
    background: var(--dark);
    color: var(--text-primary);
    height: 100dvh;
    overflow: hidden;
    -webkit-font-smoothing: antialiased;
  }

  /* ‚îÄ‚îÄ MAP ‚îÄ‚îÄ */
  #map {
    position: absolute;
    inset: 0;
    z-index: 1;
  }

  .leaflet-control-zoom { display: none; }
  .leaflet-control-attribution { font-size: 9px !important; opacity: 0.5; }

  .leaflet-control-layers {
    background: var(--dark-surface) !important;
    border: 1px solid var(--dark-border) !important;
    border-radius: 10px !important;
    box-shadow: 0 4px 16px rgba(0,0,0,0.4) !important;
    color: var(--text-primary) !important;
    font-family: 'Barlow', sans-serif !important;
    font-size: 13px !important;
  }

  .leaflet-control-layers-toggle {
    width: 36px !important; height: 36px !important;
    background-size: 20px 20px !important;
    border-radius: 10px !important;
    background-color: var(--dark-surface) !important;
    border: 1px solid var(--dark-border) !important;
    filter: invert(0.85);
  }

  .leaflet-control-layers label { color: var(--text-primary) !important; }
  .leaflet-control-layers-separator { border-color: var(--dark-border) !important; }

  /* ‚îÄ‚îÄ SHARED OVERLAYS ‚îÄ‚îÄ */
  .overlay-top {
    position: fixed;
    top: 0; left: 0; right: 0;
    z-index: 1000;
    pointer-events: none;
  }

  .overlay-top > * { pointer-events: auto; }

  .overlay-bottom {
    position: fixed;
    bottom: 0; left: 0; right: 0;
    z-index: 1000;
    pointer-events: none;
  }

  .overlay-bottom > * { pointer-events: auto; }

  /* ‚îÄ‚îÄ HEADER BAR ‚îÄ‚îÄ */
  .header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 12px 16px;
    background: linear-gradient(180deg, rgba(15,17,23,0.95) 0%, rgba(15,17,23,0.8) 80%, transparent 100%);
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
  }

  .brand {
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .brand-icon {
    width: 32px; height: 32px;
    background: var(--orange);
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
    font-weight: 800;
    color: white;
    box-shadow: 0 2px 12px var(--orange-glow);
  }

  .brand-text {
    font-size: 15px;
    font-weight: 700;
    letter-spacing: 0.5px;
    text-transform: uppercase;
  }

  .brand-sub {
    font-size: 10px;
    color: var(--text-secondary);
    letter-spacing: 1.5px;
    text-transform: uppercase;
    font-weight: 500;
  }

  .mode-badge {
    font-size: 11px;
    font-weight: 600;
    padding: 5px 12px;
    border-radius: 20px;
    letter-spacing: 0.8px;
    text-transform: uppercase;
  }

  .mode-badge.create {
    background: rgba(232, 101, 26, 0.15);
    color: var(--orange-light);
    border: 1px solid rgba(232, 101, 26, 0.3);
  }

  .mode-badge.follow {
    background: var(--teal-glow);
    color: var(--teal);
    border: 1px solid rgba(26, 191, 160, 0.3);
    animation: pulse-badge 2s ease-in-out infinite;
  }

  @keyframes pulse-badge {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.7; }
  }

  /* ‚îÄ‚îÄ BUTTONS ‚îÄ‚îÄ */
  .btn {
    font-family: 'Barlow', sans-serif;
    font-weight: 600;
    font-size: 14px;
    border: none;
    border-radius: 10px;
    padding: 12px 20px;
    cursor: pointer;
    transition: all 0.2s ease;
    letter-spacing: 0.3px;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    -webkit-tap-highlight-color: transparent;
  }

  .btn-primary {
    background: var(--orange);
    color: white;
    box-shadow: 0 4px 20px var(--orange-glow);
  }

  .btn-primary:active { transform: scale(0.97); }

  .btn-secondary {
    background: var(--dark-card);
    color: var(--text-primary);
    border: 1px solid var(--dark-border);
  }

  .btn-secondary:active { background: var(--dark-border); }

  .btn-ghost {
    background: transparent;
    color: var(--text-secondary);
    padding: 8px 12px;
  }

  .btn-danger {
    background: var(--red);
    color: white;
  }

  .btn-full { width: 100%; justify-content: center; }

  .btn:disabled {
    opacity: 0.4;
    cursor: default;
  }

  /* ‚îÄ‚îÄ CREATE MODE ‚îÄ‚îÄ */
  .create-panel {
    position: fixed;
    bottom: 0; left: 0; right: 0;
    z-index: 1000;
    background: var(--dark-surface);
    border-top: 1px solid var(--dark-border);
    border-radius: 20px 20px 0 0;
    max-height: 55vh;
    overflow-y: auto;
    transition: transform 0.3s ease;
    padding-bottom: env(safe-area-inset-bottom, 16px);
  }

  .create-panel .drag-handle {
    width: 36px;
    height: 4px;
    background: var(--dark-border);
    border-radius: 2px;
    margin: 10px auto 6px;
  }

  .panel-content {
    padding: 8px 20px 20px;
  }

  .panel-title {
    font-size: 13px;
    font-weight: 600;
    color: var(--text-secondary);
    text-transform: uppercase;
    letter-spacing: 1.5px;
    margin-bottom: 16px;
  }

  .instruction {
    font-size: 14px;
    color: var(--text-secondary);
    line-height: 1.5;
    margin-bottom: 16px;
    padding: 12px 16px;
    background: var(--dark-card);
    border-radius: 10px;
    border-left: 3px solid var(--orange);
  }

  .waypoint-list {
    list-style: none;
    margin-bottom: 16px;
  }

  .waypoint-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 10px 14px;
    background: var(--dark-card);
    border-radius: 10px;
    margin-bottom: 6px;
    font-size: 13px;
  }

  .waypoint-num {
    width: 24px; height: 24px;
    background: var(--orange);
    color: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 11px;
    font-weight: 700;
    flex-shrink: 0;
  }

  .waypoint-coords {
    font-family: 'JetBrains Mono', monospace;
    font-size: 12px;
    color: var(--text-secondary);
    flex: 1;
  }

  .waypoint-remove {
    background: none;
    border: none;
    color: var(--text-dim);
    cursor: pointer;
    font-size: 18px;
    padding: 4px 8px;
    border-radius: 6px;
  }

  .waypoint-remove:hover { color: var(--red); background: var(--red-glow); }

  .btn-group {
    display: flex;
    gap: 8px;
  }

  .file-input-wrap {
    position: relative;
    flex: 1;
  }

  .file-input-wrap input[type="file"] {
    position: absolute;
    inset: 0;
    opacity: 0;
    cursor: pointer;
  }

  /* ‚îÄ‚îÄ SEARCH BAR ‚îÄ‚îÄ */
  .search-bar {
    margin-bottom: 16px;
    position: relative;
  }

  .search-input-wrap {
    display: flex;
    align-items: center;
    background: var(--dark-card);
    border: 1px solid var(--dark-border);
    border-radius: 10px;
    padding: 0 12px;
    transition: border-color 0.2s ease;
  }

  .search-input-wrap:focus-within {
    border-color: var(--orange);
    box-shadow: 0 0 0 2px var(--orange-glow);
  }

  .search-icon {
    font-size: 16px;
    color: var(--text-dim);
    flex-shrink: 0;
    margin-right: 8px;
  }

  .search-input-wrap input {
    flex: 1;
    background: transparent;
    border: none;
    outline: none;
    color: var(--text-primary);
    font-family: 'Barlow', sans-serif;
    font-size: 14px;
    padding: 11px 0;
    min-width: 0;
  }

  .search-input-wrap input::placeholder {
    color: var(--text-dim);
  }

  .search-clear {
    background: none;
    border: none;
    color: var(--text-dim);
    font-size: 20px;
    cursor: pointer;
    padding: 4px 2px;
    flex-shrink: 0;
    line-height: 1;
  }

  .search-clear:hover { color: var(--text-secondary); }

  .search-results {
    position: absolute;
    top: calc(100% + 4px);
    left: 0; right: 0;
    background: var(--dark-surface);
    border: 1px solid var(--dark-border);
    border-radius: 12px;
    overflow: hidden;
    z-index: 100;
    box-shadow: 0 8px 32px rgba(0,0,0,0.5);
    max-height: 240px;
    overflow-y: auto;
  }

  .search-result-item {
    display: flex;
    align-items: flex-start;
    gap: 10px;
    padding: 11px 14px;
    cursor: pointer;
    transition: background 0.15s ease;
    border-bottom: 1px solid var(--dark-border);
  }

  .search-result-item:last-child { border-bottom: none; }
  .search-result-item:hover, .search-result-item:focus { background: var(--dark-card); }

  .result-icon {
    width: 28px; height: 28px;
    background: var(--dark-card);
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 13px;
    flex-shrink: 0;
    color: var(--text-secondary);
    border: 1px solid var(--dark-border);
  }

  .result-icon.coord { color: var(--teal); border-color: rgba(26,191,160,0.3); background: var(--teal-glow); }

  .result-text {
    flex: 1;
    min-width: 0;
  }

  .result-name {
    font-size: 13px;
    font-weight: 600;
    color: var(--text-primary);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .result-detail {
    font-size: 11px;
    color: var(--text-dim);
    margin-top: 2px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .search-loading {
    padding: 16px;
    text-align: center;
    font-size: 13px;
    color: var(--text-dim);
  }

  .share-output {
    margin-top: 16px;
    padding: 14px;
    background: var(--dark-card);
    border-radius: 12px;
    border: 1px solid var(--teal);
    box-shadow: 0 0 20px var(--teal-glow);
  }

  .share-output label {
    font-size: 11px;
    font-weight: 600;
    color: var(--teal);
    text-transform: uppercase;
    letter-spacing: 1px;
    display: block;
    margin-bottom: 8px;
  }

  .share-url {
    display: flex;
    gap: 8px;
    align-items: center;
  }

  .share-url input {
    flex: 1;
    background: var(--dark);
    border: 1px solid var(--dark-border);
    border-radius: 8px;
    padding: 10px 12px;
    color: var(--text-primary);
    font-family: 'JetBrains Mono', monospace;
    font-size: 11px;
    outline: none;
  }

  .share-url .btn { flex-shrink: 0; padding: 10px 16px; }

  .copied-toast {
    position: fixed;
    top: 80px;
    left: 50%;
    transform: translateX(-50%) translateY(-20px);
    background: var(--teal);
    color: var(--dark);
    font-weight: 700;
    font-size: 13px;
    padding: 10px 24px;
    border-radius: 30px;
    z-index: 9999;
    opacity: 0;
    transition: all 0.3s ease;
    pointer-events: none;
  }

  .copied-toast.show {
    opacity: 1;
    transform: translateX(-50%) translateY(0);
  }

  /* ‚îÄ‚îÄ FOLLOW MODE ‚îÄ‚îÄ */
  .follow-hud {
    position: fixed;
    bottom: 0; left: 0; right: 0;
    z-index: 1000;
    padding-bottom: env(safe-area-inset-bottom, 8px);
  }

  .hud-card {
    margin: 0 12px 12px;
    background: rgba(24, 27, 37, 0.92);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border-radius: 20px;
    border: 1px solid var(--dark-border);
    overflow: hidden;
  }

  .hud-main {
    display: grid;
    grid-template-columns: 1fr auto 1fr;
    align-items: center;
    padding: 20px 24px;
    gap: 16px;
  }

  .hud-metric {
    text-align: center;
  }

  .hud-metric .label {
    font-size: 10px;
    font-weight: 600;
    color: var(--text-dim);
    text-transform: uppercase;
    letter-spacing: 1.5px;
    margin-bottom: 4px;
  }

  .hud-metric .value {
    font-family: 'JetBrains Mono', monospace;
    font-size: 28px;
    font-weight: 600;
    color: var(--text-primary);
    line-height: 1;
  }

  .hud-metric .unit {
    font-size: 14px;
    color: var(--text-secondary);
    font-weight: 400;
    margin-left: 2px;
  }

  .compass-ring {
    width: 64px; height: 64px;
    border: 2px solid var(--dark-border);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
  }

  .compass-arrow {
    font-size: 28px;
    transition: transform 0.5s ease;
    color: var(--orange);
  }

  .compass-label {
    position: absolute;
    bottom: -18px;
    font-size: 11px;
    font-weight: 600;
    color: var(--text-secondary);
    font-family: 'JetBrains Mono', monospace;
  }

  .hud-status {
    padding: 10px 24px 14px;
    border-top: 1px solid var(--dark-border);
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  .status-indicator {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 12px;
    font-weight: 600;
  }

  .status-dot {
    width: 8px; height: 8px;
    border-radius: 50%;
    animation: blink 1.5s ease-in-out infinite;
  }

  @keyframes blink {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.3; }
  }

  .status-dot.tracking { background: var(--teal); box-shadow: 0 0 8px var(--teal-glow); }
  .status-dot.searching { background: var(--amber); }
  .status-dot.off { background: var(--red); }

  .gps-btn {
    background: var(--dark-card);
    border: 1px solid var(--dark-border);
    color: var(--text-primary);
    border-radius: 10px;
    padding: 8px 14px;
    font-family: 'Barlow', sans-serif;
    font-weight: 600;
    font-size: 12px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .waypoint-progress {
    padding: 0 24px 16px;
    border-top: 1px solid var(--dark-border);
  }

  .progress-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 0 8px;
    font-size: 11px;
    color: var(--text-dim);
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 1px;
  }

  .progress-bar-track {
    width: 100%;
    height: 4px;
    background: var(--dark-border);
    border-radius: 2px;
    overflow: hidden;
  }

  .progress-bar-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--orange), var(--teal));
    border-radius: 2px;
    transition: width 0.5s ease;
  }

  /* ‚îÄ‚îÄ RECENTER BUTTON ‚îÄ‚îÄ */
  .recenter-btn {
    position: fixed;
    right: 16px;
    bottom: 220px;
    z-index: 1000;
    width: 48px; height: 48px;
    background: var(--dark-surface);
    border: 1px solid var(--dark-border);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    box-shadow: 0 4px 16px rgba(0,0,0,0.4);
    color: var(--text-primary);
    font-size: 20px;
  }

  /* ‚îÄ‚îÄ SPLASH / LANDING ‚îÄ‚îÄ */
  .splash {
    position: fixed;
    inset: 0;
    z-index: 2000;
    background: var(--dark);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    text-align: center;
    padding: 40px 24px;
  }

  .splash-icon {
    width: 72px; height: 72px;
    background: var(--orange);
    border-radius: 18px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 36px;
    font-weight: 800;
    color: white;
    margin-bottom: 24px;
    box-shadow: 0 8px 40px var(--orange-glow);
  }

  .splash h1 {
    font-size: 32px;
    font-weight: 800;
    letter-spacing: 1px;
    margin-bottom: 8px;
  }

  .splash .tagline {
    font-size: 14px;
    color: var(--text-secondary);
    margin-bottom: 48px;
    line-height: 1.5;
    max-width: 300px;
  }

  .splash-actions {
    display: flex;
    flex-direction: column;
    gap: 12px;
    width: 100%;
    max-width: 320px;
  }

  .splash-actions .btn {
    font-size: 15px;
    padding: 16px 24px;
    border-radius: 14px;
  }

  .splash-footer {
    position: absolute;
    bottom: 32px;
    font-size: 11px;
    color: var(--text-dim);
    letter-spacing: 0.5px;
  }

  /* ‚îÄ‚îÄ ERROR OVERLAY ‚îÄ‚îÄ */
  .error-banner {
    margin: 0 12px;
    padding: 12px 16px;
    background: var(--red-glow);
    border: 1px solid var(--red);
    border-radius: 12px;
    font-size: 13px;
    color: var(--text-primary);
    display: none;
    line-height: 1.4;
  }

  /* ‚îÄ‚îÄ HOW IT WORKS PAGE ‚îÄ‚îÄ */
  .hiw-page {
    position: fixed;
    inset: 0;
    z-index: 2000;
    background: var(--dark);
    overflow-y: auto;
    -webkit-overflow-scrolling: touch;
  }

  .hiw-scroll {
    max-width: 540px;
    margin: 0 auto;
  }

  .hiw-header {
    position: sticky;
    top: 0;
    z-index: 10;
    padding: 14px 20px;
    background: rgba(15,17,23,0.9);
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
  }

  .hiw-back {
    background: none;
    border: none;
    color: var(--text-secondary);
    font-family: 'Barlow', sans-serif;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    padding: 4px 0;
    -webkit-tap-highlight-color: transparent;
  }

  .hiw-hero {
    text-align: center;
    padding: 32px 24px 40px;
  }

  .hiw-hero-icon {
    width: 56px; height: 56px;
    background: var(--orange);
    border-radius: 14px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    font-size: 28px;
    font-weight: 800;
    color: white;
    margin-bottom: 16px;
    box-shadow: 0 6px 32px var(--orange-glow);
  }

  .hiw-title {
    font-size: 28px;
    font-weight: 800;
    letter-spacing: 0.5px;
    margin-bottom: 4px;
  }

  .hiw-subtitle {
    font-size: 13px;
    color: var(--text-secondary);
    text-transform: uppercase;
    letter-spacing: 2px;
    font-weight: 600;
    margin-bottom: 20px;
  }

  .hiw-intro {
    font-size: 15px;
    color: var(--text-secondary);
    line-height: 1.65;
    max-width: 440px;
    margin: 0 auto;
  }

  .hiw-section {
    padding: 0 20px;
    margin-bottom: 36px;
  }

  .hiw-section-label {
    font-size: 11px;
    font-weight: 700;
    color: var(--orange-light);
    text-transform: uppercase;
    letter-spacing: 2px;
    margin-bottom: 16px;
    padding-left: 2px;
  }

  /* Value prop cards */
  .hiw-card {
    display: flex;
    gap: 14px;
    padding: 16px;
    background: var(--dark-surface);
    border: 1px solid var(--dark-border);
    border-radius: 14px;
    margin-bottom: 10px;
  }

  .hiw-card-icon {
    width: 40px; height: 40px;
    background: var(--dark-card);
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 18px;
    flex-shrink: 0;
  }

  .hiw-card-content { flex: 1; }

  .hiw-card-title {
    font-size: 14px;
    font-weight: 700;
    margin-bottom: 4px;
    color: var(--text-primary);
  }

  .hiw-card-content p {
    font-size: 13px;
    color: var(--text-secondary);
    line-height: 1.55;
  }

  /* Flow / Steps */
  .hiw-flow {
    display: flex;
    flex-direction: column;
    align-items: center;
  }

  .hiw-step {
    width: 100%;
    display: flex;
    flex-direction: column;
    align-items: center;
    position: relative;
  }

  .hiw-step-num {
    width: 32px; height: 32px;
    background: var(--orange);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
    font-weight: 800;
    color: white;
    margin-bottom: 14px;
    box-shadow: 0 2px 12px var(--orange-glow);
    flex-shrink: 0;
    z-index: 1;
  }

  .hiw-step-visual {
    width: 100%;
    max-width: 280px;
    margin-bottom: 14px;
  }

  .hiw-step-text {
    text-align: center;
    max-width: 360px;
    margin-bottom: 4px;
  }

  .hiw-step-title {
    font-size: 16px;
    font-weight: 700;
    margin-bottom: 6px;
  }

  .hiw-step-text p {
    font-size: 13px;
    color: var(--text-secondary);
    line-height: 1.55;
  }

  /* Mockup frame */
  .hiw-mockup {
    background: #F0F0F5;
    border-radius: 12px;
    overflow: hidden;
    border: 1px solid var(--dark-border);
    box-shadow: 0 4px 20px rgba(0,0,0,0.3);
  }

  .hiw-mockup.dark { background: var(--dark-surface); }

  .hiw-mockup.phone {
    background: var(--dark-surface);
    border-radius: 20px;
    max-width: 220px;
    margin: 0 auto;
    position: relative;
  }

  .hiw-mockup-notch {
    width: 80px;
    height: 6px;
    background: var(--dark-border);
    border-radius: 3px;
    margin: 10px auto 4px;
  }

  .hiw-mockup-bar {
    display: flex;
    gap: 5px;
    padding: 8px 12px;
    background: #E0E0E5;
  }

  .hiw-mockup-bar.dark { background: var(--dark-card); }

  .hiw-mockup-dot {
    width: 7px; height: 7px;
    background: #C0C0C5;
    border-radius: 50%;
  }

  .hiw-mockup-dot.light { background: var(--dark-border); }

  .hiw-mockup-body {
    padding: 14px;
    min-height: 100px;
  }

  .hiw-mockup-body.dark { background: var(--dark-surface); }

  /* Dispatch mockup */
  .hiw-mock-dispatch {
    font-family: 'JetBrains Mono', monospace;
  }

  .hiw-mock-label {
    font-size: 10px;
    font-weight: 700;
    color: var(--red);
    letter-spacing: 1px;
    margin-bottom: 8px;
  }

  .hiw-mock-coords {
    font-size: 13px;
    color: #1A1A2E;
    font-weight: 600;
    margin-bottom: 6px;
  }

  .hiw-mock-detail {
    font-size: 11px;
    color: #666;
    line-height: 1.5;
  }

  /* Map mockup */
  .hiw-mock-map {
    position: relative;
  }

  .hiw-mock-topo-lines {
    position: absolute;
    inset: 0;
    overflow: hidden;
    opacity: 0.15;
  }

  .hiw-mock-topo {
    border: 1px solid var(--text-secondary);
    border-radius: 50%;
    position: absolute;
  }

  .hiw-mock-topo:nth-child(1) { width: 200px; height: 120px; top: -20px; left: -40px; }
  .hiw-mock-topo:nth-child(2) { width: 160px; height: 90px; top: 0px; left: -20px; }
  .hiw-mock-topo:nth-child(3) { width: 120px; height: 70px; top: 15px; left: 0px; }

  .hiw-mock-wp-label {
    font-size: 9px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    position: absolute;
    bottom: 2px;
  }

  .hiw-mock-wp-label.start { left: 12px; color: var(--orange); }
  .hiw-mock-wp-label.end { right: 8px; color: var(--teal); }

  /* Share mockup */
  .hiw-mock-share { text-align: center; }

  .hiw-mock-share-badge {
    font-size: 11px;
    font-weight: 700;
    color: var(--teal);
    letter-spacing: 1px;
    margin-bottom: 10px;
  }

  .hiw-mock-share-url {
    font-family: 'JetBrains Mono', monospace;
    font-size: 11px;
    color: var(--text-secondary);
    background: var(--dark);
    padding: 8px 12px;
    border-radius: 8px;
    margin-bottom: 12px;
    border: 1px solid var(--dark-border);
  }

  .hiw-mock-share-actions {
    display: flex;
    gap: 8px;
    justify-content: center;
  }

  .hiw-mock-btn {
    font-size: 11px;
    font-weight: 700;
    padding: 6px 14px;
    border-radius: 8px;
  }

  .hiw-mock-btn.primary { background: var(--orange); color: white; }
  .hiw-mock-btn.secondary { background: var(--dark-card); color: var(--text-secondary); border: 1px solid var(--dark-border); }
  .hiw-mock-btn.perm { background: #007AFF; color: white; flex: 1; text-align: center; }
  .hiw-mock-btn.perm-deny { background: var(--dark-card); color: var(--text-secondary); flex: 1; text-align: center; border: 1px solid var(--dark-border); }

  /* SMS mockup */
  .hiw-mock-sms { padding: 4px 0; }

  .hiw-mock-sms-bubble {
    background: #2A2D3E;
    color: var(--text-primary);
    font-size: 12px;
    line-height: 1.5;
    padding: 10px 14px;
    border-radius: 16px 16px 16px 4px;
    margin-bottom: 6px;
    max-width: 85%;
  }

  .hiw-mock-sms-link {
    font-family: 'JetBrains Mono', monospace;
    font-size: 11px;
    color: #5AC8FA;
    text-decoration: underline;
    padding-left: 4px;
  }

  /* Permission mockup */
  .hiw-mock-permission {
    background: var(--dark-card);
    border-radius: 14px;
    padding: 20px 16px 16px;
    text-align: center;
    border: 1px solid var(--dark-border);
  }

  .hiw-mock-perm-icon { font-size: 28px; margin-bottom: 10px; }

  .hiw-mock-perm-text {
    font-size: 13px;
    color: var(--text-primary);
    line-height: 1.5;
    margin-bottom: 14px;
  }

  .hiw-mock-perm-actions {
    display: flex;
    gap: 8px;
  }

  /* Nav mockup */
  .hiw-mock-nav { }

  .hiw-mock-nav-map {
    position: relative;
    margin-bottom: 8px;
  }

  .hiw-mock-hud {
    display: flex;
    align-items: center;
    justify-content: space-between;
    background: var(--dark-card);
    border-radius: 10px;
    padding: 10px 14px;
    border: 1px solid var(--dark-border);
  }

  .hiw-mock-hud-item { text-align: center; }

  .hiw-mock-hud-label {
    display: block;
    font-size: 8px;
    font-weight: 700;
    color: var(--text-dim);
    letter-spacing: 1px;
    margin-bottom: 2px;
  }

  .hiw-mock-hud-value {
    font-family: 'JetBrains Mono', monospace;
    font-size: 18px;
    font-weight: 600;
    color: var(--text-primary);
  }

  .hiw-mock-hud-value small {
    font-size: 11px;
    color: var(--text-secondary);
    font-weight: 400;
  }

  .hiw-mock-hud-compass {
    font-size: 22px;
    color: var(--orange);
    width: 36px; height: 36px;
    border: 1.5px solid var(--dark-border);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  /* Flow connectors */
  .hiw-flow-connector {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 8px 0;
  }

  .hiw-flow-line {
    width: 1px;
    height: 20px;
    background: var(--dark-border);
  }

  .hiw-flow-arrow {
    font-size: 14px;
    color: var(--text-dim);
    margin: 2px 0;
  }

  .hiw-flow-arrow-special {
    display: flex;
    flex-direction: column;
    align-items: center;
    font-size: 14px;
    color: var(--text-dim);
  }

  .hiw-flow-arrow-special span {
    font-size: 10px;
    font-weight: 600;
    color: var(--text-dim);
    letter-spacing: 1.5px;
    text-transform: uppercase;
    background: var(--dark-card);
    padding: 4px 12px;
    border-radius: 10px;
    margin-bottom: 4px;
    border: 1px solid var(--dark-border);
  }

  /* Constraints */
  .hiw-constraints {
    display: flex;
    flex-direction: column;
    gap: 10px;
  }

  .hiw-constraint {
    display: flex;
    gap: 14px;
    padding: 14px 16px;
    background: var(--dark-surface);
    border: 1px solid var(--dark-border);
    border-radius: 12px;
  }

  .hiw-constraint-icon {
    font-size: 18px;
    flex-shrink: 0;
    padding-top: 2px;
  }

  .hiw-constraint-title {
    font-size: 13px;
    font-weight: 700;
    margin-bottom: 3px;
    color: var(--text-primary);
  }

  .hiw-constraint p {
    font-size: 12px;
    color: var(--text-secondary);
    line-height: 1.55;
  }

  /* Spirit */
  .hiw-spirit {
    text-align: center;
    padding: 28px 20px;
    position: relative;
  }

  .hiw-spirit-bar {
    width: 32px;
    height: 3px;
    background: var(--orange);
    border-radius: 2px;
    margin: 0 auto 20px;
  }

  .hiw-spirit-text {
    font-size: 15px;
    color: var(--text-secondary);
    line-height: 1.65;
    margin-bottom: 12px;
    font-style: italic;
  }

  /* Gravity branding */
  .hiw-gravity {
    text-align: center;
    padding: 24px 20px;
    background: var(--dark-surface);
    border: 1px solid var(--dark-border);
    border-radius: 16px;
  }

  .hiw-gravity-label {
    font-size: 10px;
    font-weight: 700;
    color: var(--text-dim);
    text-transform: uppercase;
    letter-spacing: 2px;
    margin-bottom: 8px;
  }

  .hiw-gravity-name {
    font-size: 22px;
    font-weight: 800;
    letter-spacing: 0.5px;
    margin-bottom: 6px;
  }

  .hiw-gravity-desc {
    font-size: 13px;
    color: var(--text-secondary);
    line-height: 1.55;
    margin-bottom: 16px;
    max-width: 340px;
    margin-left: auto;
    margin-right: auto;
  }

  .hiw-gravity-links {
    display: flex;
    flex-direction: column;
    gap: 8px;
    align-items: center;
  }

  .hiw-gravity-link {
    font-family: 'JetBrains Mono', monospace;
    font-size: 13px;
    color: var(--orange-light);
    text-decoration: none;
    padding: 6px 16px;
    border-radius: 8px;
    background: rgba(232, 101, 26, 0.08);
    border: 1px solid rgba(232, 101, 26, 0.15);
    transition: background 0.2s ease;
  }

  .hiw-gravity-link:hover { background: rgba(232, 101, 26, 0.15); }

  /* ‚îÄ‚îÄ MISC ‚îÄ‚îÄ */
  .hidden { display: none !important; }

  .leaflet-popup-content-wrapper {
    background: var(--dark-card) !important;
    color: var(--text-primary) !important;
    border-radius: 12px !important;
    box-shadow: 0 8px 32px rgba(0,0,0,0.5) !important;
    border: 1px solid var(--dark-border) !important;
  }

  .leaflet-popup-tip { background: var(--dark-card) !important; }
  .leaflet-popup-content { font-family: 'Barlow', sans-serif !important; font-size: 13px !important; }

  @media (min-width: 768px) {
    .create-panel {
      max-width: 400px;
      right: 16px;
      left: auto;
      bottom: 16px;
      border-radius: 20px;
      border: 1px solid var(--dark-border);
      max-height: 70vh;
    }
    .hud-card {
      max-width: 480px;
      margin: 0 auto 16px;
    }
  }
</style>
</head>
<body>

<!-- SPLASH SCREEN -->
<div class="splash" id="splash">
  <div class="splash-icon">‚äï</div>
  <h1>TrackPush</h1>
  <p class="tagline">Share GPS routes with anyone, instantly. Built for search and rescue teams.</p>
  <div class="splash-actions">
    <button class="btn btn-primary btn-full" onclick="enterCreate()" style="font-size: 15px;">
      ‚úö &nbsp;Create a Route
    </button>
    <button class="btn btn-secondary btn-full" onclick="showHowItWorks()" style="font-size: 15px;">
      ‚óé &nbsp;See How It Works
    </button>
  </div>
  <div class="splash-footer">No account required. No app install. Just a link.</div>
</div>

<!-- HOW IT WORKS PAGE -->
<div class="hiw-page hidden" id="hiwPage">
  <div class="hiw-scroll">

    <!-- Header -->
    <div class="hiw-header">
      <button class="hiw-back" onclick="closeHowItWorks()">‚Üê Back</button>
    </div>

    <!-- Hero -->
    <div class="hiw-hero">
      <div class="hiw-hero-icon">‚äï</div>
      <h1 class="hiw-title">TrackPush</h1>
      <p class="hiw-subtitle">GPS Route Sharing for Search & Rescue</p>
      <p class="hiw-intro">When someone is lost, injured, or disoriented in the backcountry, SAR teams often spend critical time verbally coaching them to safety over the phone. TrackPush replaces that with a simple, shareable GPS route that guides them out.</p>
    </div>

    <!-- Value Props -->
    <div class="hiw-section">
      <div class="hiw-section-label">Why TrackPush</div>

      <div class="hiw-card">
        <div class="hiw-card-icon">üß≠</div>
        <div class="hiw-card-content">
          <div class="hiw-card-title">Professional Guidance, Delivered Digitally</div>
          <p>SAR professionals draw an egress route and push it directly to a caller's phone. Navigation aids replace verbal or written instructions that are easy to misinterpret under stress.</p>
        </div>
      </div>

      <div class="hiw-card">
        <div class="hiw-card-icon">üö´</div>
        <div class="hiw-card-content">
          <div class="hiw-card-title">Zero Barriers to Entry</div>
          <p>No subscriptions. No app downloads. No account creation. No settings to configure. The user opens a link in their mobile browser, and it works.</p>
        </div>
      </div>

      <div class="hiw-card">
        <div class="hiw-card-icon">üì±</div>
        <div class="hiw-card-content">
          <div class="hiw-card-title">Simple, Effective Interface</div>
          <p>High-contrast dark UI with a clear route line, directional arrows, live GPS position, and compass bearing. Designed for cold hands, low battery, and high stress.</p>
        </div>
      </div>

      <div class="hiw-card">
        <div class="hiw-card-icon">‚úì</div>
        <div class="hiw-card-content">
          <div class="hiw-card-title">iOS & Android Compatible</div>
          <p>Runs in any modern mobile browser on both platforms. Safari, Chrome, Firefox. No platform-specific limitations.</p>
        </div>
      </div>
    </div>

    <!-- How It Works Flow -->
    <div class="hiw-section">
      <div class="hiw-section-label">How It Works</div>

      <div class="hiw-flow">

        <div class="hiw-step">
          <div class="hiw-step-num">1</div>
          <div class="hiw-step-visual">
            <div class="hiw-mockup">
              <div class="hiw-mockup-bar">
                <span class="hiw-mockup-dot"></span>
                <span class="hiw-mockup-dot"></span>
                <span class="hiw-mockup-dot"></span>
              </div>
              <div class="hiw-mockup-body">
                <div class="hiw-mock-dispatch">
                  <div class="hiw-mock-label">INCOMING ‚Äî 911 TRANSFER</div>
                  <div class="hiw-mock-coords">Caller GPS: 44.2710¬∞N, 71.3030¬∞W</div>
                  <div class="hiw-mock-detail">Subject disoriented, off-trail near Birch Lane. Requesting guidance.</div>
                </div>
              </div>
            </div>
          </div>
          <div class="hiw-step-text">
            <div class="hiw-step-title">Locate the Caller</div>
            <p>SAR receives the caller's GPS coordinates from 911 dispatch, a cell phone ping, or the caller themselves.</p>
          </div>
        </div>

        <div class="hiw-flow-connector">
          <div class="hiw-flow-line"></div>
          <div class="hiw-flow-arrow">‚Üì</div>
        </div>

        <div class="hiw-step">
          <div class="hiw-step-num">2</div>
          <div class="hiw-step-visual">
            <div class="hiw-mockup dark">
              <div class="hiw-mockup-bar dark">
                <span class="hiw-mockup-dot light"></span>
                <span class="hiw-mockup-dot light"></span>
                <span class="hiw-mockup-dot light"></span>
              </div>
              <div class="hiw-mockup-body dark">
                <div class="hiw-mock-map">
                  <div class="hiw-mock-topo-lines">
                    <div class="hiw-mock-topo"></div>
                    <div class="hiw-mock-topo"></div>
                    <div class="hiw-mock-topo"></div>
                  </div>
                  <svg width="100%" height="80" viewBox="0 0 200 80" style="position:relative;z-index:1;">
                    <circle cx="40" cy="60" r="6" fill="#E8651A" stroke="white" stroke-width="1.5"/>
                    <polyline points="40,60 70,45 110,35 150,25 180,15" stroke="#E8651A" stroke-width="3" fill="none" stroke-linecap="round"/>
                    <polygon points="90,32 96,40 90,38 84,40" fill="#E8651A" opacity="0.8"/>
                    <polygon points="140,20 146,28 140,26 134,28" fill="#E8651A" opacity="0.8"/>
                    <circle cx="180" cy="15" r="6" fill="#1ABFA0" stroke="white" stroke-width="1.5"/>
                  </svg>
                  <div class="hiw-mock-wp-label start">Caller</div>
                  <div class="hiw-mock-wp-label end">Safety</div>
                </div>
              </div>
            </div>
          </div>
          <div class="hiw-step-text">
            <div class="hiw-step-title">Create the Egress Route</div>
            <p>The SAR professional opens TrackPush, locates the caller's position on the topo map, and draws a waypoint-by-waypoint route to safety.</p>
          </div>
        </div>

        <div class="hiw-flow-connector">
          <div class="hiw-flow-line"></div>
          <div class="hiw-flow-arrow">‚Üì</div>
        </div>

        <div class="hiw-step">
          <div class="hiw-step-num">3</div>
          <div class="hiw-step-visual">
            <div class="hiw-mockup dark">
              <div class="hiw-mockup-bar dark">
                <span class="hiw-mockup-dot light"></span>
                <span class="hiw-mockup-dot light"></span>
                <span class="hiw-mockup-dot light"></span>
              </div>
              <div class="hiw-mockup-body dark">
                <div class="hiw-mock-share">
                  <div class="hiw-mock-share-badge">‚úì LINK GENERATED</div>
                  <div class="hiw-mock-share-url">trackpush.io/#follow/e8kL...</div>
                  <div class="hiw-mock-share-actions">
                    <div class="hiw-mock-btn primary">Copy Link</div>
                    <div class="hiw-mock-btn secondary">Send SMS</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="hiw-step-text">
            <div class="hiw-step-title">Generate & Send the Link</div>
            <p>One tap generates a shareable URL. The entire route is encoded into the link itself. Send it via SMS, iMessage, email, or relay it through a satellite messenger.</p>
          </div>
        </div>

        <div class="hiw-flow-connector">
          <div class="hiw-flow-line"></div>
          <div class="hiw-flow-arrow-special">
            <span>SMS / iMessage / Email</span>
            ‚Üì
          </div>
        </div>

        <div class="hiw-step">
          <div class="hiw-step-num">4</div>
          <div class="hiw-step-visual">
            <div class="hiw-mockup phone">
              <div class="hiw-mockup-notch"></div>
              <div class="hiw-mockup-body dark" style="padding-top: 20px;">
                <div class="hiw-mock-sms">
                  <div class="hiw-mock-sms-bubble incoming">Follow this link to navigate to the trailhead. Stay on the marked trail.</div>
                  <div class="hiw-mock-sms-link">trackpush.io/#follow/e8kL...</div>
                </div>
              </div>
            </div>
          </div>
          <div class="hiw-step-text">
            <div class="hiw-step-title">User Opens the Link</div>
            <p>The caller taps the link in their messages. It opens directly in their phone's browser. No app store. No account prompt. Instant access.</p>
          </div>
        </div>

        <div class="hiw-flow-connector">
          <div class="hiw-flow-line"></div>
          <div class="hiw-flow-arrow">‚Üì</div>
        </div>

        <div class="hiw-step">
          <div class="hiw-step-num">5</div>
          <div class="hiw-step-visual">
            <div class="hiw-mockup phone">
              <div class="hiw-mockup-notch"></div>
              <div class="hiw-mockup-body dark" style="padding-top: 20px;">
                <div class="hiw-mock-permission">
                  <div class="hiw-mock-perm-icon">üìç</div>
                  <div class="hiw-mock-perm-text">"TrackPush" would like to use your current location</div>
                  <div class="hiw-mock-perm-actions">
                    <div class="hiw-mock-btn perm">Allow</div>
                    <div class="hiw-mock-btn perm-deny">Don't Allow</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="hiw-step-text">
            <div class="hiw-step-title">Accept Location Permission</div>
            <p>The browser asks for GPS access. One tap on "Allow" and the app begins tracking their position on the map in real time.</p>
          </div>
        </div>

        <div class="hiw-flow-connector">
          <div class="hiw-flow-line"></div>
          <div class="hiw-flow-arrow">‚Üì</div>
        </div>

        <div class="hiw-step">
          <div class="hiw-step-num">6</div>
          <div class="hiw-step-visual">
            <div class="hiw-mockup phone">
              <div class="hiw-mockup-notch"></div>
              <div class="hiw-mockup-body dark" style="padding-top: 14px;">
                <div class="hiw-mock-nav">
                  <div class="hiw-mock-nav-map">
                    <div class="hiw-mock-topo-lines">
                      <div class="hiw-mock-topo"></div>
                      <div class="hiw-mock-topo"></div>
                    </div>
                    <svg width="100%" height="60" viewBox="0 0 180 60" style="position:relative;z-index:1;">
                      <polyline points="30,50 60,40 100,30 140,20 160,12" stroke="#E8651A" stroke-width="3" fill="none" stroke-linecap="round"/>
                      <polygon points="80,27 85,33 80,31 75,33" fill="#E8651A" opacity="0.8"/>
                      <polygon points="120,17 125,23 120,21 115,23" fill="#E8651A" opacity="0.8"/>
                      <circle cx="160" cy="12" r="5" fill="#1ABFA0" stroke="white" stroke-width="1"/>
                      <!-- User arrow -->
                      <polygon points="45,42 50,50 45,48 40,50" fill="#1ABFA0" stroke="white" stroke-width="0.8" transform="rotate(-30, 45, 46)"/>
                    </svg>
                  </div>
                  <div class="hiw-mock-hud">
                    <div class="hiw-mock-hud-item">
                      <span class="hiw-mock-hud-label">DIST</span>
                      <span class="hiw-mock-hud-value">0.4<small>mi</small></span>
                    </div>
                    <div class="hiw-mock-hud-compass">‚Üó</div>
                    <div class="hiw-mock-hud-item">
                      <span class="hiw-mock-hud-label">WP</span>
                      <span class="hiw-mock-hud-value">2/5</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="hiw-step-text">
            <div class="hiw-step-title">Follow the Route to Safety</div>
            <p>The caller sees the full egress route, their live position, a compass bearing to the next waypoint, and progress along the track. They walk. The arrow guides them.</p>
          </div>
        </div>

      </div>
    </div>

    <!-- Constraints -->
    <div class="hiw-section">
      <div class="hiw-section-label">Current Limitations</div>

      <div class="hiw-constraints">
        <div class="hiw-constraint">
          <div class="hiw-constraint-icon">üì∂</div>
          <div>
            <div class="hiw-constraint-title">Requires Cellular or WiFi</div>
            <p>The page and map tiles load over a network connection. TrackPush works when the caller has cell service. Offline tile caching is a planned future feature.</p>
          </div>
        </div>
        <div class="hiw-constraint">
          <div class="hiw-constraint-icon">üîã</div>
          <div>
            <div class="hiw-constraint-title">Battery Consideration</div>
            <p>Continuous GPS tracking and screen-on usage will consume battery. Best suited for situations where the device has sufficient charge to complete the egress.</p>
          </div>
        </div>
        <div class="hiw-constraint">
          <div class="hiw-constraint-icon">üëÅ</div>
          <div>
            <div class="hiw-constraint-title">One-Way Guidance</div>
            <p>Due to the app's serverless architecture, SAR teams cannot currently see the caller's real-time location within TrackPush. The route is pushed; progress is not reported back.</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Spirit -->
    <div class="hiw-section">
      <div class="hiw-spirit">
        <div class="hiw-spirit-bar"></div>
        <p class="hiw-spirit-text">TrackPush was built by a search and rescue professional for search and rescue professionals. It exists to remotely guide people to safety in the interconnected digital age.</p>
        <p class="hiw-spirit-text">The app is currently free, built in the spirit of creating a safer outdoor space for everyone.</p>
      </div>
    </div>

    <!-- Gravity -->
    <div class="hiw-section">
      <div class="hiw-gravity">
        <div class="hiw-gravity-label">Designed & Built By</div>
        <div class="hiw-gravity-name">Gravity Strategy</div>
        <p class="hiw-gravity-desc">A design studio and consultancy helping to build the next generation of smart outdoor technology.</p>
        <div class="hiw-gravity-links">
          <a href="https://www.gravitystrategy.co" target="_blank" class="hiw-gravity-link">gravitystrategy.co</a>
          <a href="mailto:gravityexped@gmail.com" class="hiw-gravity-link">gravityexped@gmail.com</a>
        </div>
      </div>
    </div>

    <!-- CTA -->
    <div class="hiw-section" style="padding-bottom: 48px;">
      <button class="btn btn-primary btn-full" onclick="closeHowItWorks(); enterCreate();" style="font-size: 15px; padding: 16px 24px; border-radius: 14px;">
        ‚úö &nbsp;Create a Route
      </button>
      <button class="btn btn-secondary btn-full" onclick="launchDemo()" style="font-size: 15px; padding: 16px 24px; border-radius: 14px; margin-top: 10px;">
        ‚ñ∂ &nbsp;Try the Live Demo
      </button>
    </div>

  </div>
</div>

<!-- MAP -->
<div id="map"></div>

<!-- COPIED TOAST -->
<div class="copied-toast" id="copiedToast">‚úì Link copied to clipboard</div>

<!-- HEADER -->
<div class="overlay-top">
  <div class="header hidden" id="header">
    <div class="brand">
      <div class="brand-icon">‚äï</div>
      <div>
        <div class="brand-text">TrackPush</div>
        <div class="brand-sub">SAR Route Share</div>
      </div>
    </div>
    <div class="mode-badge create" id="modeBadge">Create</div>
  </div>
  <div class="error-banner" id="errorBanner"></div>
</div>

<!-- CREATE PANEL -->
<div class="create-panel hidden" id="createPanel">
  <div class="drag-handle"></div>
  <div class="panel-content">
    <div class="panel-title">Build Route</div>
    <div class="instruction" id="createInstruction">
      Tap the map to add waypoints, or upload a GPX file. Waypoints define the path to safety.
    </div>

    <div class="search-bar" id="searchBar">
      <div class="search-input-wrap">
        <span class="search-icon">‚åï</span>
        <input type="text" id="searchInput" placeholder="Search place or paste coordinates" autocomplete="off" spellcheck="false">
        <button class="search-clear hidden" id="searchClear" onclick="clearSearch()">√ó</button>
      </div>
      <div class="search-results hidden" id="searchResults"></div>
    </div>

    <ul class="waypoint-list" id="waypointList"></ul>

    <div class="btn-group" style="margin-bottom: 12px;">
      <div class="file-input-wrap">
        <button class="btn btn-secondary btn-full">‚Üë Upload GPX</button>
        <input type="file" accept=".gpx,.GPX" id="gpxInput" onchange="handleGPX(event)">
      </div>
      <button class="btn btn-ghost" onclick="clearWaypoints()" id="clearBtn" disabled>Clear</button>
    </div>

    <button class="btn btn-primary btn-full" id="generateBtn" onclick="generateLink()" disabled>
      Generate Share Link
    </button>

    <div class="share-output hidden" id="shareOutput">
      <label>‚úì Share this link with the field party</label>
      <div class="share-url">
        <input type="text" readonly id="shareUrl">
        <button class="btn btn-primary" onclick="copyLink()">Copy</button>
      </div>
    </div>
  </div>
</div>

<!-- FOLLOW HUD -->
<div class="follow-hud hidden" id="followHud">
  <div class="hud-card">
    <div class="hud-main">
      <div class="hud-metric">
        <div class="label">Distance</div>
        <div class="value" id="hudDistance">--<span class="unit"></span></div>
      </div>
      <div class="compass-ring">
        <div class="compass-arrow" id="compassArrow">‚Üë</div>
        <div class="compass-label" id="compassBearing">---¬∞</div>
      </div>
      <div class="hud-metric">
        <div class="label">Next WP</div>
        <div class="value" id="hudNextWp">--</div>
      </div>
    </div>
    <div class="waypoint-progress" id="waypointProgress">
      <div class="progress-header">
        <span id="progressLabel">Waypoint 0 / 0</span>
        <span id="progressPct">0%</span>
      </div>
      <div class="progress-bar-track">
        <div class="progress-bar-fill" id="progressFill" style="width: 0%"></div>
      </div>
    </div>
    <div class="hud-status">
      <div class="status-indicator">
        <div class="status-dot searching" id="statusDot"></div>
        <span id="statusText">Acquiring GPS...</span>
      </div>
      <button class="gps-btn" onclick="recenterMap()">‚óé Recenter</button>
    </div>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// POLYLINE ENCODING (Google algorithm)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function encodePolyline(coords) {
  let encoded = '';
  let prevLat = 0, prevLng = 0;
  for (const [lat, lng] of coords) {
    const dLat = Math.round(lat * 1e5) - prevLat;
    const dLng = Math.round(lng * 1e5) - prevLng;
    prevLat += dLat;
    prevLng += dLng;
    encoded += encodeValue(dLat) + encodeValue(dLng);
  }
  return encoded;
}

function encodeValue(val) {
  val = val < 0 ? ~(val << 1) : val << 1;
  let encoded = '';
  while (val >= 0x20) {
    encoded += String.fromCharCode((0x20 | (val & 0x1f)) + 63);
    val >>= 5;
  }
  encoded += String.fromCharCode(val + 63);
  return encoded;
}

function decodePolyline(str) {
  const coords = [];
  let index = 0, lat = 0, lng = 0;
  while (index < str.length) {
    let b, shift = 0, result = 0;
    do { b = str.charCodeAt(index++) - 63; result |= (b & 0x1f) << shift; shift += 5; } while (b >= 0x20);
    lat += (result & 1) ? ~(result >> 1) : (result >> 1);
    shift = 0; result = 0;
    do { b = str.charCodeAt(index++) - 63; result |= (b & 0x1f) << shift; shift += 5; } while (b >= 0x20);
    lng += (result & 1) ? ~(result >> 1) : (result >> 1);
    coords.push([lat / 1e5, lng / 1e5]);
  }
  return coords;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// GEO MATH
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function haversine(lat1, lon1, lat2, lon2) {
  const R = 6371000;
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLon = (lon2 - lon1) * Math.PI / 180;
  const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180) * Math.cos(lat2*Math.PI/180) * Math.sin(dLon/2)**2;
  return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
}

function bearing(lat1, lon1, lat2, lon2) {
  const dLon = (lon2 - lon1) * Math.PI / 180;
  const y = Math.sin(dLon) * Math.cos(lat2 * Math.PI / 180);
  const x = Math.cos(lat1*Math.PI/180)*Math.sin(lat2*Math.PI/180) - Math.sin(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.cos(dLon);
  return ((Math.atan2(y, x) * 180 / Math.PI) + 360) % 360;
}

function formatDist(meters) {
  if (meters < 1000) return { val: Math.round(meters), unit: 'm' };
  if (meters < 10000) return { val: (meters/1000).toFixed(1), unit: 'km' };
  return { val: Math.round(meters/1000), unit: 'km' };
}

function formatDistMi(meters) {
  const mi = meters / 1609.344;
  if (mi < 0.1) return { val: Math.round(meters * 3.28084), unit: 'ft' };
  return { val: mi.toFixed(1), unit: 'mi' };
}

function bearingToCompass(deg) {
  const dirs = ['N','NNE','NE','ENE','E','ESE','SE','SSE','S','SSW','SW','WSW','W','WNW','NW','NNW'];
  return dirs[Math.round(deg / 22.5) % 16];
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MAP SETUP
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const map = L.map('map', {
  zoomControl: false,
  attributionControl: true,
  center: [44.27, -71.30],
  zoom: 13
});

// OpenTopoMap: topo contours + OSM trails, roads, terrain features
const topoLayer = L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
  attribution: '¬© OpenTopoMap, ¬© OpenStreetMap contributors',
  maxZoom: 17
});

// Standard OSM as fallback
const osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '¬© OpenStreetMap'
});

topoLayer.addTo(map);

// Layer switcher
L.control.layers({
  'Topo': topoLayer,
  'Street': osmLayer
}, null, { position: 'topright', collapsed: true }).addTo(map);

// Custom icons
function wpIcon(num, color = '#E8651A') {
  return L.divIcon({
    className: '',
    html: `<div style="width:28px;height:28px;background:${color};border-radius:50%;border:2px solid white;display:flex;align-items:center;justify-content:center;font-family:'Barlow',sans-serif;font-size:12px;font-weight:700;color:white;box-shadow:0 2px 8px rgba(0,0,0,0.4);">${num}</div>`,
    iconSize: [28, 28],
    iconAnchor: [14, 14]
  });
}

function userIconWithHeading(heading) {
  const rotation = heading !== null ? heading : 0;
  const opacity = heading !== null ? 1 : 0.5;
  return L.divIcon({
    className: '',
    html: `<div style="width:48px;height:64px;display:flex;align-items:center;justify-content:center;position:relative;">
      <div style="position:absolute;width:44px;height:44px;top:14px;background:rgba(26,191,160,0.1);border-radius:50%;"></div>
      <svg width="48" height="64" viewBox="0 0 48 64" style="transform:rotate(${rotation}deg);transition:transform 0.3s ease;opacity:${opacity};filter:drop-shadow(0 2px 4px rgba(0,0,0,0.4));">
        <!-- Leading pointer arrow -->
        <polygon points="24,0 28,14 24,10 20,14" fill="#1ABFA0" opacity="0.7"/>
        <!-- Main chevron -->
        <polygon points="24,14 38,42 24,35 10,42" fill="#1ABFA0" stroke="white" stroke-width="1.5" stroke-linejoin="round"/>
      </svg>
    </div>`,
    iconSize: [48, 64],
    iconAnchor: [24, 36]
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let mode = 'splash'; // splash | create | follow
let waypoints = [];
let wpMarkers = [];
let routeLine = null;
let userMarker = null;
let userAccuracyCircle = null;
let gpsWatchId = null;
let currentPos = null;
let nearestWpIdx = 0;
let followCoords = [];
let currentHeading = null;     // degrees, 0 = north
let autoFollow = true;         // auto-center on user

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SPLASH / MODE SWITCHING
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function enterCreate() {
  mode = 'create';
  document.getElementById('splash').classList.add('hidden');
  document.getElementById('header').classList.remove('hidden');
  document.getElementById('createPanel').classList.remove('hidden');
  document.getElementById('modeBadge').className = 'mode-badge create';
  document.getElementById('modeBadge').textContent = 'Create';
  map.on('click', onMapClick);
  map.invalidateSize();
}

function enterFollow(coords) {
  mode = 'follow';
  followCoords = coords;
  document.getElementById('splash').classList.add('hidden');
  document.getElementById('header').classList.remove('hidden');
  document.getElementById('createPanel').classList.add('hidden');
  document.getElementById('followHud').classList.remove('hidden');
  document.getElementById('modeBadge').className = 'mode-badge follow';
  document.getElementById('modeBadge').textContent = 'Following';
  map.off('click', onMapClick);
  map.invalidateSize();

  drawRoute(coords);
  startGPS();
}

function enterDemo() {
  // Demo route: a sample SAR egress near Mt Washington
  const demoCoords = [
    [44.2710, -71.3030],
    [44.2725, -71.3055],
    [44.2742, -71.3070],
    [44.2756, -71.3102],
    [44.2770, -71.3130],
    [44.2790, -71.3155],
    [44.2815, -71.3170]
  ];
  enterFollow(demoCoords);
}

function showHowItWorks() {
  document.getElementById('hiwPage').classList.remove('hidden');
  document.getElementById('hiwPage').scrollTop = 0;
}

function closeHowItWorks() {
  document.getElementById('hiwPage').classList.add('hidden');
}

function launchDemo() {
  closeHowItWorks();
  enterDemo();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CREATE MODE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function onMapClick(e) {
  if (mode !== 'create') return;
  addWaypoint(e.latlng.lat, e.latlng.lng);
}

function addWaypoint(lat, lng) {
  waypoints.push([lat, lng]);
  const idx = waypoints.length;
  const marker = L.marker([lat, lng], { icon: wpIcon(idx) }).addTo(map);
  wpMarkers.push(marker);
  updateRouteLine();
  renderWaypointList();
  updateCreateButtons();
}

function removeWaypoint(idx) {
  waypoints.splice(idx, 1);
  wpMarkers.forEach(m => map.removeLayer(m));
  wpMarkers = [];
  waypoints.forEach((wp, i) => {
    wpMarkers.push(L.marker(wp, { icon: wpIcon(i + 1) }).addTo(map));
  });
  updateRouteLine();
  renderWaypointList();
  updateCreateButtons();
}

function clearWaypoints() {
  waypoints = [];
  wpMarkers.forEach(m => map.removeLayer(m));
  wpMarkers = [];
  if (routeLine) { map.removeLayer(routeLine); routeLine = null; }
  renderWaypointList();
  updateCreateButtons();
  document.getElementById('shareOutput').classList.add('hidden');
}

function updateRouteLine() {
  if (routeLine) map.removeLayer(routeLine);
  if (waypoints.length >= 2) {
    routeLine = L.polyline(waypoints, {
      color: '#E8651A',
      weight: 4,
      opacity: 0.9,
      dashArray: '8, 6'
    }).addTo(map);
    map.fitBounds(routeLine.getBounds().pad(0.15));
  }
}

function renderWaypointList() {
  const list = document.getElementById('waypointList');
  if (waypoints.length === 0) {
    list.innerHTML = '';
    return;
  }
  list.innerHTML = waypoints.map((wp, i) => `
    <li class="waypoint-item">
      <div class="waypoint-num">${i + 1}</div>
      <div class="waypoint-coords">${wp[0].toFixed(5)}, ${wp[1].toFixed(5)}</div>
      <button class="waypoint-remove" onclick="removeWaypoint(${i})">√ó</button>
    </li>
  `).join('');
}

function updateCreateButtons() {
  document.getElementById('clearBtn').disabled = waypoints.length === 0;
  document.getElementById('generateBtn').disabled = waypoints.length < 2;
}

function handleGPX(event) {
  const file = event.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const parser = new DOMParser();
      const xml = parser.parseFromString(e.target.result, 'text/xml');

      // Try track points first
      let points = xml.querySelectorAll('trkpt');
      if (points.length === 0) points = xml.querySelectorAll('rtept');
      if (points.length === 0) points = xml.querySelectorAll('wpt');

      if (points.length === 0) {
        showError('No track points found in GPX file.');
        return;
      }

      clearWaypoints();

      // Simplify to manageable waypoints (max ~50 for URL length)
      const allPts = Array.from(points).map(p => [
        parseFloat(p.getAttribute('lat')),
        parseFloat(p.getAttribute('lon'))
      ]);

      const simplified = simplifyTrack(allPts, 50);
      simplified.forEach(pt => addWaypoint(pt[0], pt[1]));

    } catch (err) {
      showError('Error reading GPX file: ' + err.message);
    }
  };
  reader.readAsText(file);
  event.target.value = '';
}

function simplifyTrack(points, maxPoints) {
  if (points.length <= maxPoints) return points;
  const step = (points.length - 1) / (maxPoints - 1);
  const result = [];
  for (let i = 0; i < maxPoints; i++) {
    result.push(points[Math.round(i * step)]);
  }
  return result;
}

function generateLink() {
  if (waypoints.length < 2) return;
  const encoded = encodeURIComponent(encodePolyline(waypoints));
  const url = window.location.origin + window.location.pathname + '#follow/' + encoded;
  document.getElementById('shareUrl').value = url;
  document.getElementById('shareOutput').classList.remove('hidden');
}

function copyLink() {
  const url = document.getElementById('shareUrl').value;
  navigator.clipboard.writeText(url).then(() => {
    const toast = document.getElementById('copiedToast');
    toast.classList.add('show');
    setTimeout(() => toast.classList.remove('show'), 2000);
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FOLLOW MODE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let routeArrows = [];

function addRouteArrows(coords) {
  // Clear existing arrows
  routeArrows.forEach(m => map.removeLayer(m));
  routeArrows = [];

  if (coords.length < 2) return;

  // Calculate total route distance and place arrows at regular intervals
  const segments = [];
  let totalDist = 0;
  for (let i = 0; i < coords.length - 1; i++) {
    const d = haversine(coords[i][0], coords[i][1], coords[i+1][0], coords[i+1][1]);
    segments.push({ from: coords[i], to: coords[i+1], dist: d, cumDist: totalDist });
    totalDist += d;
  }

  // Place an arrow roughly every 150m, minimum 3 arrows, skip near start/end
  const arrowCount = Math.max(3, Math.floor(totalDist / 150));
  const interval = totalDist / (arrowCount + 1);

  for (let n = 1; n <= arrowCount; n++) {
    const targetDist = n * interval;

    // Find which segment this falls on
    for (let i = 0; i < segments.length; i++) {
      const seg = segments[i];
      if (targetDist >= seg.cumDist && targetDist <= seg.cumDist + seg.dist) {
        // Interpolate position along this segment
        const ratio = (targetDist - seg.cumDist) / seg.dist;
        const lat = seg.from[0] + (seg.to[0] - seg.from[0]) * ratio;
        const lng = seg.from[1] + (seg.to[1] - seg.from[1]) * ratio;
        const brng = bearing(seg.from[0], seg.from[1], seg.to[0], seg.to[1]);

        const arrowIcon = L.divIcon({
          className: '',
          html: `<svg width="16" height="16" viewBox="0 0 16 16" style="transform:rotate(${brng}deg);filter:drop-shadow(0 1px 2px rgba(0,0,0,0.3));">
            <polygon points="8,1 14,12 8,9 2,12" fill="#E8651A" opacity="0.85"/>
          </svg>`,
          iconSize: [16, 16],
          iconAnchor: [8, 8]
        });

        const marker = L.marker([lat, lng], { icon: arrowIcon, interactive: false }).addTo(map);
        routeArrows.push(marker);
        break;
      }
    }
  }
}

function drawRoute(coords) {
  wpMarkers.forEach(m => map.removeLayer(m));
  wpMarkers = [];
  if (routeLine) map.removeLayer(routeLine);

  // Draw route line
  routeLine = L.polyline(coords, {
    color: '#E8651A',
    weight: 5,
    opacity: 0.9,
    lineCap: 'round'
  }).addTo(map);

  // Add directional arrows along the route
  addRouteArrows(coords);

  // Add start and end markers
  const startIcon = L.divIcon({
    className: '',
    html: `<div style="width:32px;height:32px;background:#E8651A;border-radius:50%;border:3px solid white;display:flex;align-items:center;justify-content:center;font-size:14px;color:white;box-shadow:0 2px 12px rgba(0,0,0,0.4);">‚óâ</div>`,
    iconSize: [32, 32], iconAnchor: [16, 16]
  });

  const endIcon = L.divIcon({
    className: '',
    html: `<div style="width:36px;height:36px;background:#1ABFA0;border-radius:50%;border:3px solid white;display:flex;align-items:center;justify-content:center;font-size:16px;color:white;box-shadow:0 2px 12px rgba(0,0,0,0.4);font-weight:bold;">‚úì</div>`,
    iconSize: [36, 36], iconAnchor: [18, 18]
  });

  wpMarkers.push(L.marker(coords[0], { icon: startIcon }).addTo(map).bindPopup('Start'));
  wpMarkers.push(L.marker(coords[coords.length - 1], { icon: endIcon }).addTo(map).bindPopup('Safety / Destination'));

  // Intermediate waypoints
  coords.forEach((c, i) => {
    if (i === 0 || i === coords.length - 1) return;
    if (coords.length > 10 && i % Math.ceil(coords.length / 10) !== 0) return;
    const m = L.circleMarker(c, {
      radius: 4, fillColor: '#FF8642', fillOpacity: 0.8, color: 'white', weight: 1
    }).addTo(map);
    wpMarkers.push(m);
  });

  map.fitBounds(routeLine.getBounds().pad(0.15));
}

function startGPS() {
  if (!navigator.geolocation) {
    updateStatus('off', 'GPS not available');
    return;
  }

  updateStatus('searching', 'Acquiring GPS...');

  gpsWatchId = navigator.geolocation.watchPosition(
    (pos) => {
      currentPos = { lat: pos.coords.latitude, lng: pos.coords.longitude, acc: pos.coords.accuracy };

      // Use GPS heading when moving (more reliable than compass)
      if (pos.coords.heading !== null && !isNaN(pos.coords.heading) && pos.coords.speed > 0.5) {
        currentHeading = pos.coords.heading;
      }

      updateUserPosition();
      updateHUD();
      updateStatus('tracking', `GPS active ¬∑ ¬±${Math.round(currentPos.acc)}m`);
    },
    (err) => {
      updateStatus('off', 'GPS error: ' + err.message);
    },
    { enableHighAccuracy: true, timeout: 15000, maximumAge: 2000 }
  );

  // Start device compass for heading when stationary
  startCompass();
}

function startCompass() {
  // iOS 13+ requires permission
  if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
    DeviceOrientationEvent.requestPermission()
      .then(state => {
        if (state === 'granted') {
          window.addEventListener('deviceorientation', handleCompass, true);
        }
      })
      .catch(() => {});
    return;
  }

  // Android: prefer deviceorientationabsolute (true north guaranteed)
  if ('ondeviceorientationabsolute' in window) {
    window.addEventListener('deviceorientationabsolute', handleCompass, true);
  } else if ('DeviceOrientationEvent' in window) {
    window.addEventListener('deviceorientation', handleCompass, true);
  }
}

function handleCompass(e) {
  let heading = null;

  // iOS: webkitCompassHeading is degrees from true north
  if (e.webkitCompassHeading !== undefined) {
    heading = e.webkitCompassHeading;
  }
  // Android (deviceorientationabsolute or absolute:true): alpha from true north
  else if (e.alpha !== null && (e.absolute === true || e.type === 'deviceorientationabsolute')) {
    heading = (360 - e.alpha) % 360;
  }

  if (heading !== null) {
    // Only use compass heading when GPS heading isn't available (stationary)
    if (currentPos && (!currentPos.speed || currentPos.speed < 0.5)) {
      currentHeading = heading;
      if (userMarker) {
        userMarker.setIcon(userIconWithHeading(currentHeading));
      }
    }
  }
}

function updateUserPosition() {
  if (!currentPos) return;
  const latlng = [currentPos.lat, currentPos.lng];

  if (!userMarker) {
    userMarker = L.marker(latlng, { icon: userIconWithHeading(currentHeading), zIndexOffset: 1000 }).addTo(map);
    userAccuracyCircle = L.circle(latlng, {
      radius: currentPos.acc,
      fillColor: '#1ABFA0',
      fillOpacity: 0.08,
      color: '#1ABFA0',
      weight: 1,
      opacity: 0.3
    }).addTo(map);
    // Initial center on user
    if (autoFollow) map.setView(latlng, 16);
  } else {
    userMarker.setLatLng(latlng);
    userMarker.setIcon(userIconWithHeading(currentHeading));
    userAccuracyCircle.setLatLng(latlng);
    userAccuracyCircle.setRadius(currentPos.acc);
    if (autoFollow) map.setView(latlng, map.getZoom());
  }
}


function updateHUD() {
  if (!currentPos || followCoords.length === 0) return;

  // Find nearest upcoming waypoint
  let minDist = Infinity;
  let nearestIdx = nearestWpIdx;

  for (let i = nearestWpIdx; i < followCoords.length; i++) {
    const d = haversine(currentPos.lat, currentPos.lng, followCoords[i][0], followCoords[i][1]);
    if (d < minDist) { minDist = d; nearestIdx = i; }
  }

  // Advance past waypoints we're close to (within 30m)
  if (minDist < 30 && nearestIdx < followCoords.length - 1) {
    nearestWpIdx = nearestIdx + 1;
    nearestIdx = nearestWpIdx;
    minDist = haversine(currentPos.lat, currentPos.lng, followCoords[nearestIdx][0], followCoords[nearestIdx][1]);
  }

  // Distance
  const dist = formatDistMi(minDist);
  document.getElementById('hudDistance').innerHTML = `${dist.val}<span class="unit">${dist.unit}</span>`;

  // Bearing
  const brng = bearing(currentPos.lat, currentPos.lng, followCoords[nearestIdx][0], followCoords[nearestIdx][1]);
  document.getElementById('compassArrow').style.transform = `rotate(${brng}deg)`;
  document.getElementById('compassBearing').textContent = `${Math.round(brng)}¬∞ ${bearingToCompass(brng)}`;

  // Next waypoint number
  document.getElementById('hudNextWp').textContent = `${nearestIdx + 1}`;

  // Progress
  const totalWp = followCoords.length;
  const pct = Math.round((nearestWpIdx / (totalWp - 1)) * 100);
  document.getElementById('progressLabel').textContent = `Waypoint ${nearestWpIdx + 1} / ${totalWp}`;
  document.getElementById('progressPct').textContent = `${pct}%`;
  document.getElementById('progressFill').style.width = `${pct}%`;
}

function updateStatus(type, text) {
  const dot = document.getElementById('statusDot');
  dot.className = `status-dot ${type}`;
  document.getElementById('statusText').textContent = text;
}

function recenterMap() {
  autoFollow = true;
  if (currentPos) {
    map.setView([currentPos.lat, currentPos.lng], 16);
  } else if (followCoords.length > 0) {
    map.fitBounds(L.latLngBounds(followCoords).pad(0.15));
  }
}

// Stop auto-follow when user manually pans
map.on('dragstart', () => { autoFollow = false; });

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ERROR HANDLING
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showError(msg) {
  const banner = document.getElementById('errorBanner');
  banner.textContent = msg;
  banner.style.display = 'block';
  setTimeout(() => { banner.style.display = 'none'; }, 5000);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SEARCH / GEOCODING
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let searchTimeout = null;

document.getElementById('searchInput').addEventListener('input', function(e) {
  const q = e.target.value.trim();
  const clearBtn = document.getElementById('searchClear');
  clearBtn.classList.toggle('hidden', q.length === 0);

  clearTimeout(searchTimeout);
  if (q.length < 2) { hideSearchResults(); return; }

  // Check for coordinate input first
  const coordResult = parseCoordinates(q);
  if (coordResult) {
    showCoordResult(coordResult, q);
    return;
  }

  // Debounce geocoding requests
  searchTimeout = setTimeout(() => geocodeSearch(q), 350);
});

document.getElementById('searchInput').addEventListener('keydown', function(e) {
  if (e.key === 'Enter') {
    e.preventDefault();
    const q = e.target.value.trim();
    const coordResult = parseCoordinates(q);
    if (coordResult) {
      selectSearchResult(coordResult.lat, coordResult.lng, q);
      return;
    }
    clearTimeout(searchTimeout);
    geocodeSearch(q);
  }
  if (e.key === 'Escape') {
    hideSearchResults();
    e.target.blur();
  }
});

function parseCoordinates(input) {
  // Supports: "44.2710, -71.3030" | "44.2710 -71.3030" | "44¬∞16'15.6"N 71¬∞18'10.8"W" | DMS variants
  const cleaned = input.replace(/\s+/g, ' ').trim();

  // Decimal degrees: 44.2710, -71.3030 or 44.2710 -71.3030
  const dd = cleaned.match(/^(-?\d+\.?\d*)[,\s]+(-?\d+\.?\d*)$/);
  if (dd) {
    const lat = parseFloat(dd[1]), lng = parseFloat(dd[2]);
    if (lat >= -90 && lat <= 90 && lng >= -180 && lng <= 180) {
      return { lat, lng };
    }
  }

  // DMS: 44¬∞16'15.6"N 71¬∞18'10.8"W (flexible)
  const dms = cleaned.match(/(\d+)[¬∞d]\s*(\d+)[‚Ä≤']\s*([\d.]+)[‚Ä≥"]?\s*([NSns])[,\s]+(\d+)[¬∞d]\s*(\d+)[‚Ä≤']\s*([\d.]+)[‚Ä≥"]?\s*([EWew])/);
  if (dms) {
    let lat = parseInt(dms[1]) + parseInt(dms[2])/60 + parseFloat(dms[3])/3600;
    let lng = parseInt(dms[5]) + parseInt(dms[6])/60 + parseFloat(dms[7])/3600;
    if (dms[4].toUpperCase() === 'S') lat = -lat;
    if (dms[8].toUpperCase() === 'W') lng = -lng;
    if (lat >= -90 && lat <= 90 && lng >= -180 && lng <= 180) {
      return { lat, lng };
    }
  }

  return null;
}

async function geocodeSearch(query) {
  const resultsDiv = document.getElementById('searchResults');
  resultsDiv.classList.remove('hidden');
  resultsDiv.innerHTML = '<div class="search-loading">Searching...</div>';

  try {
    const resp = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=5&addressdetails=1`, {
      headers: { 'Accept-Language': 'en' }
    });
    const data = await resp.json();

    if (data.length === 0) {
      resultsDiv.innerHTML = '<div class="search-loading">No results found</div>';
      return;
    }

    resultsDiv.innerHTML = data.map(item => {
      const typeIcon = getTypeIcon(item.type, item.class);
      const name = item.display_name.split(',')[0];
      const detail = item.display_name.split(',').slice(1, 3).join(',').trim();
      return `<div class="search-result-item" onclick="selectAndAddWaypoint(${item.lat}, ${item.lon})">
        <div class="result-icon">${typeIcon}</div>
        <div class="result-text">
          <div class="result-name">${name}</div>
          <div class="result-detail">${detail}</div>
        </div>
      </div>`;
    }).join('');
  } catch (err) {
    resultsDiv.innerHTML = '<div class="search-loading">Search failed. Try coordinates instead.</div>';
  }
}

function showCoordResult(coord, raw) {
  const resultsDiv = document.getElementById('searchResults');
  resultsDiv.classList.remove('hidden');
  resultsDiv.innerHTML = `
    <div class="search-result-item" onclick="selectSearchResult(${coord.lat}, ${coord.lng}, 'Coordinates')">
      <div class="result-icon coord">‚äï</div>
      <div class="result-text">
        <div class="result-name">Go to coordinates</div>
        <div class="result-detail">${coord.lat.toFixed(5)}, ${coord.lng.toFixed(5)}</div>
      </div>
    </div>
    <div class="search-result-item" onclick="selectAndAddWaypoint(${coord.lat}, ${coord.lng})">
      <div class="result-icon" style="color:var(--orange);border-color:rgba(232,101,26,0.3);background:rgba(232,101,26,0.1);">+</div>
      <div class="result-text">
        <div class="result-name">Add as waypoint</div>
        <div class="result-detail">${coord.lat.toFixed(5)}, ${coord.lng.toFixed(5)}</div>
      </div>
    </div>`;
}

function selectSearchResult(lat, lng, name) {
  hideSearchResults();
  document.getElementById('searchInput').value = '';
  document.getElementById('searchClear').classList.add('hidden');
  map.setView([lat, lng], 15);
}

function selectAndAddWaypoint(lat, lng) {
  hideSearchResults();
  document.getElementById('searchInput').value = '';
  document.getElementById('searchClear').classList.add('hidden');
  addWaypoint(lat, lng);
  map.setView([lat, lng], 15);
}

function clearSearch() {
  document.getElementById('searchInput').value = '';
  document.getElementById('searchClear').classList.add('hidden');
  hideSearchResults();
}

function hideSearchResults() {
  document.getElementById('searchResults').classList.add('hidden');
}

function getTypeIcon(type, cls) {
  if (cls === 'natural') return '‚õ∞';
  if (cls === 'highway' || type === 'path' || type === 'track') return 'ü•æ';
  if (cls === 'waterway' || type === 'river' || type === 'stream') return '„Ä∞';
  if (type === 'peak' || type === 'mountain') return '‚ñ≥';
  if (type === 'village' || type === 'town' || type === 'city') return '‚åÇ';
  if (cls === 'amenity') return '‚óâ';
  if (cls === 'tourism') return '‚öë';
  return '‚óá';
}

// Close results when clicking outside
document.addEventListener('click', function(e) {
  if (!e.target.closest('.search-bar')) hideSearchResults();
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// URL HASH ROUTING
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function checkHash() {
  const hash = window.location.hash;
  if (hash.startsWith('#follow/')) {
    const encoded = decodeURIComponent(hash.slice(8));
    try {
      const coords = decodePolyline(encoded);
      if (coords.length >= 2) {
        enterFollow(coords);
        return;
      }
    } catch (e) {
      showError('Invalid route link.');
    }
  }
  // Show splash if no valid hash
}

// Initialize
checkHash();

// Handle hash changes
window.addEventListener('hashchange', () => {
  if (window.location.hash.startsWith('#follow/')) {
    location.reload();
  }
});
</script>
</body>
</html>
